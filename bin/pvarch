#!/usr/bin/env python
#
# main pvarch application

import sys, os, time, warnings
import getopt
try:
    import EpicsArchiver
except:
    print 'cannot import EpicsArchiver'
    sys.exit(1)


def show_usage():
    print """    pvarch:   run and interact with Epics PV Archiver and MySQL process
    
    pvarch -h            shows this message.
    pvarch status        shows cache status, some recent statistics.
    pvarch check         returns # of variables updated in past minute. Should be >1!
    pvarch restart       restarts the caching process
    pvarch add_pv        add a PV to the currently running cache
    pvarch drop_pv       add a PV to the currently running cache

    pvarch add_pvfile    read a file of PVs to add to the Archiver

    pvarch cache start        start cache process (if it's not already running)
           cache stop         stop  cache process
           cache restart      restart cache process
           cache status   t   show # of PVs cached in past t seconds (default=60)
           cache activity t   show list of PVs cached in past t seconds (default=60)
    """
    sys.exit()


def next_archive(master):
    master  = EpicsArchiver.ArchiveMaster()
    dbname  = master.get_currentDB()

    next_db = master.make_nextdb()
    print 'next database = %s ' % next_db
    master.request_stop()
    master.set_pid(0)
    master.set_currentDB(next_db)
    time.sleep(2.0)
    run_archive(action='start')

def run_archive(action='start'):
    config = EpicsArchiver.config

    def archive_loop():
        master  = EpicsArchiver.ArchiveMaster()
        dbname  = master.get_currentDB()
        a       = EpicsArchiver.Archiver(dbname=dbname,master=master)
        a.mainloop()

    master  = EpicsArchiver.ArchiveMaster()
    dbname  = master.get_currentDB()
    dir     = config.dblogdir
    sout    = os.path.join(dir, "%s.log" % dbname)
    serr    = os.path.join(dir, "%s.err" % dbname)
    pidfile = os.path.join(dir, "pvarch.pid")


    EpicsArchiver.startstop(stdout =sout,stderr=serr, pidfile=pidfile,
                            process_name='pvarch', action=action,
                            func = archive_loop)

    #archive_loop()
    

def run_cache(action=None):
    config = EpicsArchiver.config


    def cache_loop():
        cache   = EpicsArchiver.Cache()
        cache.mainloop()

    dir     = config.dblogdir
    if not os.path.exists(dir):   os.mkdir(dir)
    sout    = os.path.join(dir, "cache.out")
    serr    = os.path.join(dir, "cache.err")
    pidfile = os.path.join(dir, "cache.pid")
    

    EpicsArchiver.startstop(stdout =sout,stderr=serr, pidfile=pidfile,
                            process_name='pvcache', action=action,
                            func = cache_loop)
   

def read_cache_pid():
    config = EpicsArchiver.config
    pidfile = "%s/cache.pid" % config.dblogdir
    try:
        pf  = file(pidfile,'r')
        pid = int(pf.read().strip())
        pf.close()
    except IOError:
        pid = None
    return pid
    
def cache_status(action='activity', dt=60):
    pid   = read_cache_pid()

    cache = EpicsArchiver.Cache()
    ret   = cache.get_recent(dt=dt)
    status= 'running'
    if pid != cache.get_pid(): status = 'not running!'
        
    if 'activity' == action:
        for r in ret:
            print "  %s   %.29s = %s" % (time.strftime("%H:%M:%S",time.localtime(r['ts'])),r['name']+' '*20,r['value'])
    print '%i changed PVs cached in past %i seconds.  PID=%i  Status=%s' % (len(ret), int(dt),cache.get_pid(),status)    
    
def main():
    opts, args = getopt.getopt(sys.argv[1:], "h", ["help"])
    try:
        cmd = args.pop(0)
    except IndexError:
        cmd = 'help'
    for (k,v) in opts:
        if k in ("-h", "--help"): cmd = 'help'

    config  = EpicsArchiver.config

    if   'help' == cmd:      show_usage()
    elif 'status' == cmd:
        print 'status '
        if read_cache_pid() is None:
            print "Cache is not running: start Cache with 'pvarch cache start' first!"
        else:
            print 'cache is running'
    elif cmd in ('start','stop','restart'):
        run_archive(action=cmd)
            
    elif 'check' == cmd:     print 'check ?'
    elif 'add_pv' == cmd:    print 'add_pv ? '
    elif 'add_pvfile' == cmd:
        for pvfile in args:  EpicsArchiver.add_pvfile(pvfile)

    elif 'cache' == cmd:
        action = args.pop(0)

        if action not in ('start','stop','restart','status','activity'):
            print "'pvarch cache' needs one of start, stop, restart, status, activity"
            print "    Try 'pvarch -h' "
            
        if action in ('status','activity'):
            dt = 60
            if len(args)>0: dt = args.pop(0)
            cache_status(action=action,dt=float(dt))
        else:
            run_cache(action=action)
           

    else: print "pvarch  unknown command '%s'.    Try 'pvarch -h'" % cmd

main()
